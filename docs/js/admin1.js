(()=>{"use strict";const e=(e,t=0)=>{document.cookie=`admin=${e.trim()}; path='/'`+(t?"; max-age="+3600*t*24:"")};class t{constructor({url:e,errorMessageResponse:t="Ошибка сервера.",headers:s={"Content-Type":"application/json"}}){this._url=e,this._errorMessageResponse=t,this._headers=s}async request(e="GET",t="",s={}){document.preloader.start();try{const n={method:e,headers:this._headers};"POST PATCH PUT".includes(e)&&(n.body=JSON.stringify(s));const r=await fetch(this._url+t,n);if(!r.ok)throw new Error(this._errorMessageResponse);const a=await r.json();return document.preloader.stop(),a}catch(e){return document.preloader.stop(),console.error(e.message),[]}}use(e){return this.request("GET",e?`/${e}`:"")}filter(e){return this.request("GET",`?${e}`)}useSort(e){return this.request("GET",`?_sort=${e.field}&_order=${e.order}`)}add(e){return this.request("POST","",e)}delete(e){return this.request("DELETE",`/${e}`)}edit(e,t){return this.request("PUT",`/${e}`,t)}change(e,t){return this.request("PATCH",`/${e}`,t)}}const s=()=>{document.getElementById("tds").shadowRoot.querySelectorAll(".-tds-heading-row svg").forEach(((e,t)=>{e.classList.remove("nosorting"),e.classList.remove("sorting"),e.classList.add("nosorting")}))},n=()=>{const e=document.getElementById("typeItem");document.dataItems.useSort({field:"type",order:"asc"}).then((t=>{let s="Все типы услуг",n=`<option value="${s}">${s}</option>`;t.forEach((e=>{e.type!==s&&(n+=`<option value="${e.type}">${e.type}</option>`,s=e.type)})),e.innerHTML=n,e.selectedIndex=0}))},r=()=>{const e=document.getElementById("typeItem"),t=e.options[e.selectedIndex].textContent,n=document.getElementById("tds");e.selectedIndex?document.dataItems.filter(`type=${t}`).then((e=>{n.data=e,n.records.filterApply.length&&n.records.filterRefrech(),s()})):document.dataItems.use().then((e=>{n.data=e,n.records.filterApply.length&&n.records.filterRefrech(),s()}))},a=window.location;document.preloader=new class{constructor(){const e=document.createElement("div"),t=document.createElement("div");let s=document.createElement("div");e.classList.add("preloader"),t.classList.add("preloader__row"),s.classList.add("preloader__item"),t.append(s),t.append(s.cloneNode(!1)),e.append(t),document.querySelector("body").append(e),this._preloader=e}start(){this._preloader.classList.add("working")}stop(){window.setTimeout((()=>{this._preloader.classList.remove("working")}),500)}},a.pathname.includes("table.html")?(document.dataItems=new t({url:"http://localhost:4545/items",errorMessageResponse:"Сервер базы данных недоступен. Действие отменено."}),(()=>{const e=document.getElementById("tds");e.use({data:[],headingHeight:50,rowHeight:50,gapCol:0,hrefCSS:"./styles/tableHidden.css",columns:[{id:"id",width:110,widthMin:110,widthMax:110,when:e=>!0,head:()=>'<div class="table-th th-id">ID<span class="svg_ui">\n          <svg class="icon-sort nosorting"><use xlink:href="./img/sprite.svg#sorting"></use>\n          </svg></span></div>',cell:"id",cellSay:e=>`<span class="id">${e.id}</span>`},{id:"type",width:200,widthMin:200,widthMax:200,when:e=>!0,head:()=>'<div class="table-th th-type">Тип услуги<span class="svg_ui">\n            <svg class= "icon-sort nosorting"> <use xlink:href="./img/sprite.svg#sorting"></use>\n            </svg></span></div>',cell:"type"},{id:"name",width:300,widthMin:300,widthMax:300,when:e=>!0,head:()=>'<div class="table-th th-name">Виды работ<span class="svg_ui">\n            <svg class="icon-sort nosorting"><use xlink:href="./img/sprite.svg#sorting"></use>\n            </svg></span></div>',cell:"name"},{id:"units",width:113,widthMin:113,widthMax:113,when:e=>!0,head:()=>'<div class="table-th th-units">Еденицы измерения<span class="svg_ui">\n            <svg class="icon-sort nosorting"><use xlink:href="./img/sprite.svg#sorting"></use>\n            </svg></span></div>',cell:"units",cellSay:e=>`<span class="units">${e.units}</span>`},{id:"cost",width:110,widthMin:110,widthMax:110,when:e=>!0,head:()=>'<div class="table-th th-cost">Цена за единицу<span class="svg_ui">\n            <svg class="icon-sort nosorting"><use xlink:href="./img/sprite.svg#sorting"></use>\n            </svg></span></div>',cell:e=>+(e.cost+"").replace(/[^\d]+/g,""),cellSay:e=>`<span class="cost">${e.cost} руб</span>`},{width:138,widthMin:138,widthMax:138,when:e=>!1,head:"Действия",cell:"permissions",cellSay:e=>'\n          <div class="table__actions">\n            <button class="button action-change"><span class="svg_ui"><svg class="action-icon_change">\n              <use xlink:href="./img/sprite.svg#change"></use>\n              </svg></span><span>Изменить</span>\n            </button>\n            <button class="button action-remove"><span class="svg_ui"><svg class="action-icon_remove">\n              <use xlink:href="./img/sprite.svg#remove"></use>\n              </svg></span><span>Удалить</span>\n            </button>\n          </div>'}]}),document.dataItems.use().then((t=>{e.data=t}))})(),(()=>{const e=document.getElementById("typeItem");n(),e.addEventListener("change",(e=>{r()}))})(),document.querySelector(".admin-exit").prepend((()=>{const e=document.cookie.match(/(?:^|; )admin=([^;]*)/);return e&&"deleted"!==e[1]?e[1]:void 0})()),document.querySelector(".admin-exit button").addEventListener("click",(()=>{const t=window.location;e("deleted",0),t.replace(t.toString().replace("/table.html",""))})),(()=>{const e=document.getElementById("modal"),t=document.querySelector(".input_filter_name"),a=document.querySelector(".btn-addItem"),o=e.querySelector(".modal__header"),i=e.querySelector("form"),d=i.querySelectorAll("input"),l=i.querySelector("#type"),c=document.getElementById("typeItem"),u=document.getElementById("tds"),m={type:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,name:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,units:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,cost:/[^\d]+/gi,trimSH:/(^[\s\-]+|^)(.*?)(?:([\s\-]+$)|$)/i,multySH:/(\s{2,})|(\-{2,})/g},g={type:30,name:70,units:20,cost:9},p=()=>{d.forEach((e=>{e.readOnly||(e.value=""),e.classList.remove("error")}))},h=(t=!0)=>{const s=c.options[c.selectedIndex].textContent,n=0===c.selectedIndex;if(l.readOnly=!n,p(),t){const e=u.records.current().data;o.textContent="Изменение услуги",o.idItem=e.id,d.forEach((t=>{t.value=e[t.id]}))}else o.textContent="Добавление новой услуги",o.idItem=0,l.value=n?"":s;e.style.display="block"};a.addEventListener("click",(e=>{h(!1)})),i.addEventListener("input",(e=>{const t=e.target.id;e.target.matches("input")&&t in m&&(e.target.value=e.target.value.replace(m[t],"").slice(0,g[t]),e.target.classList.remove("error"))})),i.addEventListener("focusout",(e=>{if(e.target.matches("input")){let t=e.target.value;t=t.replace(m.trimSH,((e,t,s)=>`${s}`)),t=t.replace(m.multySH,((e,t,s)=>(t?" ":"")+(s?"-":""))),e.target.value=t}})),e.addEventListener("click",(t=>{!t.target.closest(".modal")||t.target.closest(".button__close")||t.target.closest(".cancel-button")?e.style.display="none":t.target.closest(".button-ui_firm")&&(()=>{if((()=>{let e=!0;return d.forEach((t=>{let s=!0;/.+/.test(t.value)||(s=!1),s?t.classList.remove("error"):t.classList.add("error"),s||(e=!1)})),e})()){const t={};d.forEach((e=>{t[e.id]=e.value})),t.cost=+t.cost,o.idItem?document.dataItems.edit(o.idItem,t).then((t=>{c.selectedIndex||n(),u.records.change(t),e.style.display="none"})):document.dataItems.add(t).then((e=>{c.selectedIndex||n(),u.records.append(e),p()}))}})()})),u.shadowRoot.addEventListener("click",(e=>{e.target.closest(".action-change")?h():e.target.closest(".action-remove")?(()=>{const e=u.records.current();document.dataItems.delete(e.data.id).then((e=>{c.selectedIndex&&1===u.data.length?(c.selectedIndex=0,n(),r()):u.records.delete()}))})():e.target.closest(".table-th")&&(e=>{const t=e.classList.contains("nosorting")?"sorting":e.classList.contains("sorting")?"none":"nosorting";s(),"nosorting"===t?u.records.sortOff():"sorting"===t?(e.classList.remove("nosorting"),e.classList.add("sorting"),u.records.sort("",1)):(e.classList.remove("nosorting"),u.records.sort("",-1))})(e.target.querySelector("svg"))})),document.querySelector(".filter_on").addEventListener("click",(e=>{t.value.trim()&&(t.classList.add("filter_run"),t.readOnly=!0,u.records.filter("tds0",{colId:"name",compare:t.value,loose:!0}))})),document.querySelector(".filter_off").addEventListener("click",(e=>{t.classList.remove("filter_run"),t.readOnly=!1,u.records.filterOff()})),i.addEventListener("submit",(e=>{e.preventDefault()}))})()):(document.dataAdmin=new t({url:"http://localhost:4545/users",errorMessageResponse:"Сервер регистрации недоступен. Аутентификация невозможна."}),((t=30)=>{const s=document.querySelector("form"),n=s.querySelector("#name"),r=s.querySelector("#type"),a=s.querySelector(".button-ui_firm"),o=s.querySelector(".remember"),i=(e,t)=>{n.nextElementSibling.style.display=e?"":"initial",e||(n.value=""),r.nextElementSibling.style.display=t?"":"initial",t||(r.value="")};s.addEventListener("input",(e=>{e.target.matches(".input")&&("name"===e.target.id&&(e.target.value=e.target.value.replace(/[\s]+/gi,"")),e.target.nextElementSibling.style.display="")})),a.addEventListener("click",(()=>{n.value?document.dataAdmin.use().then((s=>{const a=s.find((e=>e.login===n.value));if(i(a,!a||a.password===r.value),a&&a.password===r.value){const s=window.location;e(n.value,o.checked?t:0),s.replace(s.toString().replace(/[^\/]*$/,"")+"table.html")}})):i(n.value,!0)})),s.addEventListener("submit",(e=>e.preventDefault()))})(30))})();