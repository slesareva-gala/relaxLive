(()=>{"use strict";class e{constructor({url:e,urlDemo:t,errorMessageResponse:s="Ошибка сервера.",headers:a={"Content-Type":"application/json"}}){this._url=e,this._urlDemo=t,this._errorMessageResponse=s,this._headers=a}async request(e="GET",t="",s={}){document.preloader.start();try{const a={method:e,headers:this._headers};let n;"POST PATCH PUT".includes(e)&&(a.body=JSON.stringify(s));try{if(n=await fetch(this._url+t,a),!n.ok)throw new Error(this._errorMessageResponse)}catch(e){if(n=await fetch(this._urlDemo+t,a),!n.ok)throw new Error(this._errorMessageResponse);console.error("Страница переключена на демонстрационный режим"),document.taskDemo=1}const o=await n.json();return document.preloader.stop(),o}catch(e){throw document.preloader.stop(),new Error(this._errorMessageResponse)}}use(e){return this.request("GET",e?`/${e}`:"")}filter(e){return this.request("GET",`?${e}`)}useSort(e){return this.request("GET",`?_sort=${e.field}&_order=${e.order}`)}add(e){return this.request("POST","",e)}delete(e){return this.request("DELETE",`/${e}`)}edit(e,t){return this.request("PUT",`/${e}`,t)}change(e,t){return this.request("PATCH",`/${e}`,t)}}const t=(e,t=0)=>{document.cookie=`admin=${e.trim()}; path='/'`+(t?"; max-age="+3600*t*24:"")},s={type:30,name:70,units:20,cost:9},a={type:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,name:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,units:/[^а-яёa-z\s\d\.\,\;\:\-\?\!\)\(\"]+/gi,cost:/[^\d]+/gi,trimSH:/(^[\s\-]+|^)(.*?)(?:([\s\-]+$)|$)/i,multySH:/(\s{2,})|(\-{2,})/g},n=window.location;document.preloader=new class{constructor(){const e=document.createElement("div"),t=document.createElement("div");let s=document.createElement("div");e.classList.add("preloader"),t.classList.add("preloader__row"),s.classList.add("preloader__item"),t.append(s),t.append(s.cloneNode(!1)),e.append(t),document.querySelector("body").append(e),this._preloader=e}start(){this._preloader.classList.add("working")}stop(){window.setTimeout((()=>{this._preloader.classList.remove("working")}),500)}},n.pathname.includes("table.html")?(document.taskDemo=0,document.dataСatalog=new e({url:"http://localhost:4545/items",urlDemo:"../dbDemo/items.json",errorMessageResponse:"Сервер базы данных недоступен. Действие отменено."}),(()=>{const e=document.querySelector(".main"),n=e.querySelector(".input_filter_name"),o=e.querySelector("#typeItem"),r=e.querySelector("#catalog"),d=e.querySelector(".btn-addItem"),i=document.getElementById("modal"),c=i.querySelector(".modal__header"),l=i.querySelector("form"),u=l.querySelectorAll("input"),m=l.querySelector("#type"),h=()=>{r.shadowRoot.querySelectorAll(".icon-sort").forEach((e=>{e.classList.remove("asc","desc")}))},p=()=>{const t=o.selectedIndex?o.options[o.selectedIndex].textContent:"";r.data=t?e.data.filter((e=>e.type===t)):e.data.slice(),r.records.filterApply.length&&r.records.filterRefrech(),h()},v=()=>{const t=new Set;let s='<option value="Все типы услуг">Все типы услуг</option>';e.data.forEach((e=>t.add(e.type))),[...t].sort().forEach((e=>{s+=`<option value="${e}">${e}</option>`})),o.innerHTML=s,o.selectedIndex=0},g=()=>{u.forEach((e=>{e.readOnly||(e.value=""),e.classList.remove("error")}))},y=(e=!0)=>{const t=o.options[o.selectedIndex].textContent,s=0===o.selectedIndex;if(m.readOnly=!s,g(),e){const e=r.records.current().data;c.textContent="Изменение услуги",c.idItem=e.id,u.forEach((t=>{t.value=e[t.id]}))}else c.textContent="Добавление новой услуги",c.idItem=0,m.value=s?"":t;i.style.display="block"};o.addEventListener("change",(e=>{p()})),d.addEventListener("click",(e=>{y(!1)})),l.addEventListener("input",(e=>{const t=e.target.id;e.target.matches("input")&&t in a&&(e.target.value=e.target.value.replace(a[t],"").slice(0,s[t]),e.target.classList.remove("error"))})),l.addEventListener("focusout",(e=>{if(e.target.matches("input")){let t=e.target.value;t=t.replace(a.trimSH,((e,t,s)=>`${s}`)),t=t.replace(a.multySH,((e,t,s)=>(t?" ":"")+(s?"-":""))),e.target.value=t}})),i.addEventListener("click",(t=>{!t.target.closest(".modal")||t.target.closest(".button__close")||t.target.closest(".cancel-button")?i.style.display="none":t.target.closest(".button-ui_firm")&&(()=>{const t=t=>{e.data[e.data.findIndex((e=>e.id===c.idItem))]=Object.assign({},t),o.selectedIndex||v(),r.records.change(t),i.style.display="none"},s=t=>{e.data.push(Object.assign({},t)),o.selectedIndex||v(),r.records.append(t),g()};if((()=>{let e=!0;return u.forEach((t=>{let s=!0;/.+/.test(t.value)||(s=!1),s?t.classList.remove("error"):t.classList.add("error"),s||(e=!1)})),e})()){const e={};u.forEach((t=>{e[t.id]=t.value})),e.cost=+e.cost,c.idItem?document.taskDemo?(e.id=c.idItem,t(e)):document.dataСatalogdataСatalog.edit(c.idItem,e).then((e=>{t(e)})):document.taskDemo?(e.id="demo"+document.taskDemo,s(e),document.taskDemo++):document.dataСatalog.add(e).then((e=>{s(e)}))}})()})),r.shadowRoot.addEventListener("click",(t=>{const s=t.target.closest(".column-head");t.target.closest(".action-change")?y():t.target.closest(".action-remove")?(()=>{const t=r.records.current(),s=()=>{e.data.splice(e.data.findIndex((e=>e.id===t.data.id)),1),0===r.yMax?(v(),p()):r.records.delete()};document.taskDemo?s():document.dataСatalog.delete(t.data.id).then((e=>{s()}))})():s&&((e,t)=>{const s=e.querySelector(".icon-sort");t||(t=s.classList.contains("asc")?"desc":s.classList.contains("desc")?"none":"asc"),h(),"none"===t?r.records.sortOff():"asc"===t?(s.classList.add("asc"),r.records.sort("",1)):(s.classList.add("desc"),r.records.sort("",-1))})(s)})),document.querySelector(".filter_on").addEventListener("click",(e=>{n.value.trim()&&(n.classList.add("filter_run"),n.readOnly=!0,r.records.filter("tds0",{colId:"name",compare:n.value,loose:!0}))})),document.querySelector(".filter_off").addEventListener("click",(e=>{n.classList.remove("filter_run"),n.readOnly=!1,r.records.filterOff()})),l.addEventListener("submit",(e=>{e.preventDefault()})),document.querySelector(".admin-exit button").addEventListener("click",(()=>{const e=window.location;t("deleted",0),e.replace(e.toString().replace("/table.html",""))})),document.querySelector(".admin-exit").prepend((()=>{const e=document.cookie.match(/(?:^|; )admin=([^;]*)/);return e&&"deleted"!==e[1]?e[1]:void 0})()),(e=>{e.use({data:[],headingHeight:50,rowHeight:50,gapCol:0,hrefCSS:"./css/catalogHidden.css",columns:[{id:"id",width:110,widthMin:110,widthMax:110,when:e=>!0,head:()=>'<div class="column-head">ID<span class="icon-sort">&#129093</span></div>',cell:"id",cellSay:e=>`<span class="id">${e.id}</span>`},{id:"type",width:200,widthMin:200,widthMax:200,when:e=>!0,head:()=>'<div class="column-head">Тип услуги<span class="icon-sort">&#129093</span></div>',cell:"type"},{id:"name",width:300,widthMin:300,widthMax:300,when:e=>!0,head:()=>'<div class="column-head">Виды работ<span class="icon-sort">&#129093</span></div>',cell:"name"},{id:"units",width:113,widthMin:113,widthMax:113,when:e=>!0,head:()=>'<div class="column-head"><div class="min-width">Единицы измерения</div><span class="icon-sort">&#129093</span></div>',cell:"units"},{id:"cost",width:110,widthMin:110,widthMax:110,when:e=>!0,head:()=>'<div class="column-head"><div class="min-width">Цена за единицу</div><span class="icon-sort">&#129093</span></div>',cell:e=>+(e.cost+"").replace(/[^\d]+/g,""),cellSay:e=>`<span>${e.cost} руб</span>`},{width:138,widthMin:138,widthMax:138,when:e=>!1,head:()=>'<div class="column-head no-pointer">Действия</div>',cell:"permissions",cellSay:e=>'<div class="table__actions"><button class="button action-change"><span class="action-icon_change">&#128394;</span><span>Изменить</span></button><button class="button action-remove"><span class="action-icon_remove">&#11198;</span><span>Удалить</span></button></div>'}]})})(r),document.dataСatalog.use().then((t=>{e.data=t,v(),p()}))})()):(document.dataAdmin=new e({url:"http://localhost:4545/users",urlDemo:"../dbDemo/users.json",errorMessageResponse:"Сервер регистрации недоступен. Аутентификация невозможна."}),((e=30)=>{const s=document.querySelector("form"),a=s.querySelector("#name"),n=s.querySelector("#type"),o=s.querySelector(".button-ui_firm"),r=s.querySelector(".remember"),d=(e,t)=>{a.nextElementSibling.style.display=e?"":"initial",e||(a.value=""),n.nextElementSibling.style.display=t?"":"initial",t||(n.value="")};s.addEventListener("input",(e=>{e.target.matches(".input")&&("name"===e.target.id&&(e.target.value=e.target.value.replace(/[\s]+/gi,"")),e.target.nextElementSibling.style.display="")})),o.addEventListener("click",(()=>{a.value?document.dataAdmin.use().then((s=>{const o=s.find((e=>e.login===a.value));if(d(o,!o||o.password===n.value),o&&o.password===n.value){const s=window.location;t(a.value,r.checked?e:0),s.replace(s.toString().replace(/[^\/]*$/,"")+"table.html")}})):d(a.value,!0)})),s.addEventListener("submit",(e=>e.preventDefault()))})(30))})();